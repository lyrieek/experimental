<html>

	<head>
	    <link rel="Stylesheet" type="text/css" href="csdn.detail.css" />
	</head>

	<body>
		<div class="markdown_views"><p>遇到了token验证的需求，然后下了一个demo，因为我只用到了token的生成和验证，所以根据自己的需求整理了一下，原版demo下载：<a href="http://download.csdn.net/detail/qierkang/9792660" target="_blank">http://download.csdn.net/detail/qierkang/9792660</a> <br>
1. 加密工具类，XXTEAUtil</p>



<pre class="prettyprint"><code class=" hljs java">
<span class="hljs-keyword">import</span> org.apache.commons.codec.binary.Base64;


<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">XXTEAUtil</span> {</span>

    <span class="hljs-javadoc">/**
     * 使用密钥加密数据
     *<span class="hljs-javadoctag"> @param</span> plain
     *<span class="hljs-javadoctag"> @param</span> key
     *<span class="hljs-javadoctag"> @return</span>
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] <span class="hljs-title">encrypt</span>(<span class="hljs-keyword">byte</span>[] plain, <span class="hljs-keyword">byte</span>[] key) {
        <span class="hljs-keyword">if</span> (plain.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> plain;
        }
        <span class="hljs-keyword">return</span> toByteArray(encrypt(toIntArray(plain, <span class="hljs-keyword">true</span>), toIntArray(key, <span class="hljs-keyword">false</span>)), <span class="hljs-keyword">false</span>);
    }

    <span class="hljs-javadoc">/**
     * 使用密钥解密
     *<span class="hljs-javadoctag"> @param</span> cipher
     *<span class="hljs-javadoctag"> @param</span> key
     *<span class="hljs-javadoctag"> @return</span>
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] <span class="hljs-title">decrypt</span>(<span class="hljs-keyword">byte</span>[] cipher, <span class="hljs-keyword">byte</span>[] key) {
        <span class="hljs-keyword">if</span> (cipher.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> cipher;
        }
        <span class="hljs-keyword">return</span> toByteArray(decrypt(toIntArray(cipher, <span class="hljs-keyword">false</span>), toIntArray(key, <span class="hljs-keyword">false</span>)), <span class="hljs-keyword">true</span>);
    }

    <span class="hljs-javadoc">/**
     * 使用密钥加密数据
     *<span class="hljs-javadoctag"> @param</span> v
     *<span class="hljs-javadoctag"> @param</span> k
     *<span class="hljs-javadoctag"> @return</span>
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] <span class="hljs-title">encrypt</span>(<span class="hljs-keyword">int</span>[] v, <span class="hljs-keyword">int</span>[] k) {
        <span class="hljs-keyword">int</span> n = v.length - <span class="hljs-number">1</span>;

        <span class="hljs-keyword">if</span> (n &lt; <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> v;
        }
        <span class="hljs-keyword">if</span> (k.length &lt; <span class="hljs-number">4</span>) {
            <span class="hljs-keyword">int</span>[] key = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">4</span>];

            System.arraycopy(k, <span class="hljs-number">0</span>, key, <span class="hljs-number">0</span>, k.length);
            k = key;
        }
        <span class="hljs-keyword">int</span> z = v[n], y = v[<span class="hljs-number">0</span>], delta = <span class="hljs-number">0x9E3779B9</span>, sum = <span class="hljs-number">0</span>, e;
        <span class="hljs-keyword">int</span> p, q = <span class="hljs-number">6</span> + <span class="hljs-number">52</span> / (n + <span class="hljs-number">1</span>);

        <span class="hljs-keyword">while</span> (q-- &gt; <span class="hljs-number">0</span>) {
            sum = sum + delta;
            e = sum &gt;&gt;&gt; <span class="hljs-number">2</span> &amp; <span class="hljs-number">3</span>;
            <span class="hljs-keyword">for</span> (p = <span class="hljs-number">0</span>; p &lt; n; p++) {
                y = v[p + <span class="hljs-number">1</span>];
                z = v[p] += (z &gt;&gt;&gt; <span class="hljs-number">5</span> ^ y &lt;&lt; <span class="hljs-number">2</span>) + (y &gt;&gt;&gt; <span class="hljs-number">3</span> ^ z &lt;&lt; <span class="hljs-number">4</span>) ^ (sum ^ y) + (k[p &amp; <span class="hljs-number">3</span> ^ e] ^ z);
            }
            y = v[<span class="hljs-number">0</span>];
            z = v[n] += (z &gt;&gt;&gt; <span class="hljs-number">5</span> ^ y &lt;&lt; <span class="hljs-number">2</span>) + (y &gt;&gt;&gt; <span class="hljs-number">3</span> ^ z &lt;&lt; <span class="hljs-number">4</span>) ^ (sum ^ y) + (k[p &amp; <span class="hljs-number">3</span> ^ e] ^ z);
        }
        <span class="hljs-keyword">return</span> v;
    }

    <span class="hljs-javadoc">/**
     * 使用密钥解密数据
     *<span class="hljs-javadoctag"> @param</span> v
     *<span class="hljs-javadoctag"> @param</span> k
     *<span class="hljs-javadoctag"> @return</span>
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] <span class="hljs-title">decrypt</span>(<span class="hljs-keyword">int</span>[] v, <span class="hljs-keyword">int</span>[] k) {
        <span class="hljs-keyword">int</span> n = v.length - <span class="hljs-number">1</span>;

        <span class="hljs-keyword">if</span> (n &lt; <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> v;
        }
        <span class="hljs-keyword">if</span> (k.length &lt; <span class="hljs-number">4</span>) {
            <span class="hljs-keyword">int</span>[] key = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">4</span>];

            System.arraycopy(k, <span class="hljs-number">0</span>, key, <span class="hljs-number">0</span>, k.length);
            k = key;
        }
        <span class="hljs-keyword">int</span> z = v[n], y = v[<span class="hljs-number">0</span>], delta = <span class="hljs-number">0x9E3779B9</span>, sum, e;
        <span class="hljs-keyword">int</span> p, q = <span class="hljs-number">6</span> + <span class="hljs-number">52</span> / (n + <span class="hljs-number">1</span>);

        sum = q * delta;
        <span class="hljs-keyword">while</span> (sum != <span class="hljs-number">0</span>) {
            e = sum &gt;&gt;&gt; <span class="hljs-number">2</span> &amp; <span class="hljs-number">3</span>;
        <span class="hljs-keyword">for</span> (p = n; p &gt; <span class="hljs-number">0</span>; p--) {
            z = v[p - <span class="hljs-number">1</span>];
            y = v[p] -= (z &gt;&gt;&gt; <span class="hljs-number">5</span> ^ y &lt;&lt; <span class="hljs-number">2</span>) + (y &gt;&gt;&gt; <span class="hljs-number">3</span> ^ z &lt;&lt; <span class="hljs-number">4</span>) ^ (sum ^ y) + (k[p &amp; <span class="hljs-number">3</span> ^ e] ^ z);
        }
        z = v[n];
        y = v[<span class="hljs-number">0</span>] -= (z &gt;&gt;&gt; <span class="hljs-number">5</span> ^ y &lt;&lt; <span class="hljs-number">2</span>) + (y &gt;&gt;&gt; <span class="hljs-number">3</span> ^ z &lt;&lt; <span class="hljs-number">4</span>) ^ (sum ^ y) + (k[p &amp; <span class="hljs-number">3</span> ^ e] ^ z);
        sum = sum - delta;
        }
        <span class="hljs-keyword">return</span> v;
    }

    <span class="hljs-javadoc">/**
     * 字节数组转换为整型数组
     *<span class="hljs-javadoctag"> @param</span> data
     *<span class="hljs-javadoctag"> @param</span> includeLength
     *<span class="hljs-javadoctag"> @return</span>
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] <span class="hljs-title">toIntArray</span>(<span class="hljs-keyword">byte</span>[] data, <span class="hljs-keyword">boolean</span> includeLength) {
        <span class="hljs-keyword">int</span> n = (((data.length &amp; <span class="hljs-number">3</span>) == <span class="hljs-number">0</span>) ? (data.length &gt;&gt;&gt; <span class="hljs-number">2</span>) : ((data.length &gt;&gt;&gt; <span class="hljs-number">2</span>) + <span class="hljs-number">1</span>));
        <span class="hljs-keyword">int</span>[] result;

        <span class="hljs-keyword">if</span> (includeLength) {
            result = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[n + <span class="hljs-number">1</span>];
            result[n] = data.length;
        } <span class="hljs-keyword">else</span> {
            result = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[n];
        }
        n = data.length;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) {
            result[i &gt;&gt;&gt; <span class="hljs-number">2</span>] |= (<span class="hljs-number">0x000000ff</span> &amp; data[i]) &lt;&lt; ((i &amp; <span class="hljs-number">3</span>) &lt;&lt; <span class="hljs-number">3</span>);
        }
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-javadoc">/**
     * 整型数组转换为字节数组
     *<span class="hljs-javadoctag"> @param</span> data
     *<span class="hljs-javadoctag"> @param</span> includeLength
     *<span class="hljs-javadoctag"> @return</span>
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] <span class="hljs-title">toByteArray</span>(<span class="hljs-keyword">int</span>[] data, <span class="hljs-keyword">boolean</span> includeLength) {
        <span class="hljs-keyword">int</span> n = data.length &lt;&lt; <span class="hljs-number">2</span>;
        <span class="hljs-keyword">if</span> (includeLength) {
            <span class="hljs-keyword">int</span> m = data[data.length - <span class="hljs-number">1</span>];

            <span class="hljs-keyword">if</span> (m &gt; n) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
            } <span class="hljs-keyword">else</span> {
                n = m;
            }
        }
        <span class="hljs-keyword">byte</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[n];

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) {
            result[i] = (<span class="hljs-keyword">byte</span>) ((data[i &gt;&gt;&gt; <span class="hljs-number">2</span>] &gt;&gt;&gt; ((i &amp; <span class="hljs-number">3</span>) &lt;&lt; <span class="hljs-number">3</span>)) &amp; <span class="hljs-number">0xff</span>);
        }
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-javadoc">/**
     * 先XXXTEA加密，后Base64加密
     *<span class="hljs-javadoctag"> @param</span> plain
     *<span class="hljs-javadoctag"> @param</span> key
     *<span class="hljs-javadoctag"> @return</span>
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">encrypt</span>(String plain, String key) {
        String cipher = <span class="hljs-string">""</span>;
        <span class="hljs-keyword">byte</span>[] k = key.getBytes();
        <span class="hljs-keyword">byte</span>[] v = plain.getBytes();
        cipher = <span class="hljs-keyword">new</span> String(Base64.encodeBase64(XXTEAUtil.encrypt(v, k)));
        cipher = cipher.replace(<span class="hljs-string">'+'</span>, <span class="hljs-string">'-'</span>);
        cipher = cipher.replace(<span class="hljs-string">'/'</span>, <span class="hljs-string">'_'</span>);
        cipher = cipher.replace(<span class="hljs-string">'='</span>, <span class="hljs-string">'.'</span>);
        <span class="hljs-keyword">return</span> cipher;
    }

    <span class="hljs-javadoc">/**
     * 先Base64解密，后XXXTEA解密
     *<span class="hljs-javadoctag"> @param</span> cipher
     *<span class="hljs-javadoctag"> @param</span> key
     *<span class="hljs-javadoctag"> @return</span>
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">decrypt</span>(String cipher, String key) {
        String plain = <span class="hljs-string">""</span>;
        cipher = cipher.replace(<span class="hljs-string">'-'</span>, <span class="hljs-string">'+'</span>);
        cipher = cipher.replace(<span class="hljs-string">'_'</span>, <span class="hljs-string">'/'</span>);
        cipher = cipher.replace(<span class="hljs-string">'.'</span>, <span class="hljs-string">'='</span>);
        <span class="hljs-keyword">byte</span>[] k = key.getBytes();
        <span class="hljs-keyword">byte</span>[] v = Base64.decodeBase64(cipher);
        plain = <span class="hljs-keyword">new</span> String(XXTEAUtil.decrypt(v, k));
        <span class="hljs-keyword">return</span> plain;
    }

}</code></pre>

<p>2 . token的生成和验证</p>



<pre class="prettyprint"><code class=" hljs java">
<span class="hljs-keyword">import</span> java.util.Random;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-keyword">import</span> org.apache.commons.lang.StringUtils;


<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TokenUtil</span> {</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] codeBase= {<span class="hljs-string">"0"</span>,<span class="hljs-string">"1"</span>,<span class="hljs-string">"2"</span>,<span class="hljs-string">"3"</span>,<span class="hljs-string">"4"</span>,<span class="hljs-string">"5"</span>,<span class="hljs-string">"6"</span>,<span class="hljs-string">"7"</span>,<span class="hljs-string">"8"</span>,<span class="hljs-string">"9"</span>,<span class="hljs-string">"A"</span>,<span class="hljs-string">"B"</span>,<span class="hljs-string">"C"</span>,<span class="hljs-string">"D"</span>,<span class="hljs-string">"E"</span>,<span class="hljs-string">"F"</span>,<span class="hljs-string">"G"</span>,<span class="hljs-string">"H"</span>,<span class="hljs-string">"I"</span>,<span class="hljs-string">"J"</span>,<span class="hljs-string">"K"</span>,<span class="hljs-string">"L"</span>,<span class="hljs-string">"M"</span>,<span class="hljs-string">"N"</span>,<span class="hljs-string">"O"</span>,<span class="hljs-string">"P"</span>,<span class="hljs-string">"Q"</span>,<span class="hljs-string">"R"</span>,<span class="hljs-string">"S"</span>,<span class="hljs-string">"T"</span>,<span class="hljs-string">"U"</span>,<span class="hljs-string">"V"</span>,<span class="hljs-string">"W"</span>,<span class="hljs-string">"X"</span>,<span class="hljs-string">"Y"</span>,<span class="hljs-string">"Z"</span>,<span class="hljs-string">"a"</span>,<span class="hljs-string">"b"</span>,<span class="hljs-string">"c"</span>,<span class="hljs-string">"d"</span>,<span class="hljs-string">"e"</span>,<span class="hljs-string">"f"</span>,<span class="hljs-string">"g"</span>,<span class="hljs-string">"h"</span>,<span class="hljs-string">"i"</span>,<span class="hljs-string">"j"</span>,<span class="hljs-string">"k"</span>,<span class="hljs-string">"l"</span>,<span class="hljs-string">"m"</span>,<span class="hljs-string">"n"</span>,<span class="hljs-string">"o"</span>,<span class="hljs-string">"p"</span>,<span class="hljs-string">"q"</span>,<span class="hljs-string">"r"</span>,<span class="hljs-string">"s"</span>,<span class="hljs-string">"t"</span>,<span class="hljs-string">"u"</span>,<span class="hljs-string">"v"</span>,<span class="hljs-string">"w"</span>,<span class="hljs-string">"x"</span>,<span class="hljs-string">"y"</span>,<span class="hljs-string">"z"</span>};

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Random rand= <span class="hljs-keyword">new</span> Random();

    <span class="hljs-javadoc">/** XXTEA加密解密的密钥 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String secKey = <span class="hljs-string">"captcha"</span>;

    <span class="hljs-javadoc">/** token超时门限(天) */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> expire = <span class="hljs-number">30</span>;


    <span class="hljs-javadoc">/** 验证码字符数 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> charCount = <span class="hljs-number">4</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span>  String  <span class="hljs-title">genToken</span>() {
        StringBuffer sb= <span class="hljs-keyword">new</span> StringBuffer();
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;charCount; i++){
            <span class="hljs-keyword">int</span> randInt= Math.abs(rand.nextInt());
            sb.append(codeBase[randInt % codeBase.length]);
        }
        <span class="hljs-keyword">long</span> timestamp= System.currentTimeMillis();
        String token= <span class="hljs-keyword">null</span>;
        token= String.format(<span class="hljs-string">"%s_%d"</span>, sb.toString(), timestamp);
        System.out.println(<span class="hljs-string">"未加密的token:"</span>+token);
        token= XXTEAUtil.encrypt(token, secKey);
        <span class="hljs-keyword">return</span> token;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">verificationToken</span>(String token) <span class="hljs-keyword">throws</span> StatusInfoException{
        String plainText= XXTEAUtil.decrypt(token, secKey);
        <span class="hljs-keyword">if</span> (StringUtils.isBlank(plainText)){
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"解密失败,token可能遭到篡改"</span>);
            }
            String[] plainTextArr= plainText.split(<span class="hljs-string">"_"</span>);
            <span class="hljs-keyword">if</span> (plainTextArr.length!=<span class="hljs-number">2</span>){
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"token数据格式错误"</span>);
            }
            <span class="hljs-keyword">long</span> timestamp= <span class="hljs-number">0</span>;
            <span class="hljs-keyword">try</span>{
                timestamp= Long.parseLong(plainTextArr[<span class="hljs-number">1</span>]);
            }<span class="hljs-keyword">catch</span>(NumberFormatException e){
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"时间戳无效"</span>);
            }
            <span class="hljs-keyword">if</span> ((System.currentTimeMillis() - timestamp)&gt;TimeUnit.MILLISECONDS.convert(expire+<span class="hljs-number">5</span>, TimeUnit.DAYS)){
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"token已过期"</span>);
            }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    }
}</code></pre>

<p>具体用到哪些jar包，可以下载demo看</p></div>
        </div>
	</body>

</html>